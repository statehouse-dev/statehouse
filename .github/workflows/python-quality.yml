name: Python Code Quality

on:
  push:
    branches:
      - main
    paths:
      - 'python/**'
      - 'tutorials/**'
      - 'examples/**'
      - 'scripts/py_*.sh'
      - '.github/workflows/python-quality.yml'
  pull_request:
    paths:
      - 'python/**'
      - 'tutorials/**'
      - 'examples/**'
      - 'scripts/py_*.sh'
      - '.github/workflows/python-quality.yml'

jobs:
  lint-and-format:
    name: Linting and Formatting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install ruff
      
      - name: Check formatting
        run: |
          ruff format --check python/ tutorials/ examples/
      
      - name: Run linting
        run: |
          ruff check python/ tutorials/ examples/
  
  test-sdk:
    name: SDK Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd python
          pip install -e .
          pip install pytest pytest-asyncio
      
      - name: Run formatting tests
        run: |
          cd python
          pytest tests/test_formatting.py -v
  
  test-tutorials:
    name: Tutorial Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Build Statehouse daemon
        run: |
          cargo build --release --bin statehoused
      
      - name: Install Python SDK
        run: |
          cd python
          pip install -e .
      
      - name: Start daemon (in-memory mode)
        run: |
          STATEHOUSE_USE_MEMORY=1 ./target/release/statehoused &
          DAEMON_PID=$!
          echo "DAEMON_PID=$DAEMON_PID" >> $GITHUB_ENV
          # Wait for daemon to start
          sleep 3
      
      - name: Run tutorial integration tests
        run: |
          python3 tutorials/test_tutorial_01.py
      
      - name: Stop daemon
        if: always()
        run: |
          if [ ! -z "$DAEMON_PID" ]; then
            kill $DAEMON_PID || true
          fi
  
  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, test-sdk, test-tutorials]
    if: always()
    
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.lint-and-format.result }}" != "success" ] || \
             [ "${{ needs.test-sdk.result }}" != "success" ] || \
             [ "${{ needs.test-tutorials.result }}" != "success" ]; then
            echo "Some quality checks failed"
            exit 1
          fi
          echo "All quality checks passed!"
